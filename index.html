<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partner Link Test</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>Partner Link Test</h1>
  <p class="subtitle">Test partner link tracking with different form submission modes</p>

  <!-- Test Mode Toggle -->
  <div class="test-mode">
    <label class="checkbox-label">
      <input type="checkbox" id="ajax-mode" checked>
      <span>AJAX Mode (preventDefault - simulates Webflow/Squarespace)</span>
    </label>
    <p class="mode-description" id="mode-description">
      ✓ Form submission prevented - page stays loaded (like AJAX forms)
    </p>
  </div>

  <form id="test-form">
    <div class="form-group">
      <label for="fname">First Name</label>
      <input type="text" id="fname" name="FName" required>
    </div>

    <div class="form-group">
      <label for="lname">Last Name</label>
      <input type="text" id="lname" name="LName" required>
    </div>

    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" name="Email" required>
    </div>

    <div class="form-group">
      <label for="phone">Phone</label>
      <input type="tel" id="phone" name="Phone" required>
    </div>

    <button type="submit">Submit</button>
  </form>

  <div id="output"></div>

  <!-- Partner Link Script -->
  <script src="https://widget.partner.io/partnerLink.js"></script>
  <script>
    window.partnerLinkLibrary.init();
  </script>

  <!-- Form Tracking Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('test-form');
      const output = document.getElementById('output');
      const ajaxModeCheckbox = document.getElementById('ajax-mode');
      const modeDescription = document.getElementById('mode-description');

      if (!form) {
        output.innerHTML = 'ERROR: Form not found';
        return;
      }

      // Update mode description when checkbox changes
      ajaxModeCheckbox.addEventListener('change', function () {
        if (ajaxModeCheckbox.checked) {
          modeDescription.innerHTML = '✓ Form submission prevented - page stays loaded (like AJAX forms)';
          modeDescription.className = 'mode-description ajax';
        } else {
          modeDescription.innerHTML = '⚠️ Form will submit naturally - page will reload (like traditional forms)';
          modeDescription.className = 'mode-description traditional';
        }
      });

      form.addEventListener('submit', function (event) {
        const isAjaxMode = ajaxModeCheckbox.checked;

        // Only preventDefault if in AJAX mode
        if (isAjaxMode) {
          event.preventDefault();
        }

        output.innerHTML = 'Processing...';

        // Check if Partner Link library is loaded
        if (!window.partnerLinkLibrary) {
          output.innerHTML = 'ERROR: Partner Link library not loaded';
          if (!isAjaxMode) {
            alert('ERROR: Partner Link library not loaded (form will still submit)');
          }
          return;
        }

        // Check if PLID exists
        const plid = window.partnerLinkLibrary.getPlid();
        if (!plid) {
          const errorMsg = 'No Partner Link ID found in URL. Add ?plid=YOUR_ID to the URL.';
          output.innerHTML = `ERROR: ${errorMsg}`;
          if (!isAjaxMode) {
            alert(`ERROR: ${errorMsg} (form will still submit)`);
          }
          return;
        }

        // Extract form data
        const signUpData = window.partnerLinkLibrary.getSignUpDataFromFormElement(form);
        console.log('Extracted data:', signUpData);

        // Send to Partner.io (fire and forget)
        if (signUpData && signUpData.length > 0) {
          const request = window.partnerLinkLibrary.recordSignUpEvent(signUpData);

          // Show results (only works in AJAX mode)
          if (request && request.then && isAjaxMode) {
            request
              .then(function (statusCode) {
                console.log('API status code:', statusCode);

                output.innerHTML = `
                  <strong>SUCCESS</strong><br>
                  Status Code: ${statusCode}<br>
                  PLID: ${plid}<br>
                  Mode: ${isAjaxMode ? 'AJAX (preventDefault)' : 'Traditional (natural submit)'}<br>
                  Data sent: ${JSON.stringify(signUpData, null, 2)}<br>
                  Check Network tab for POST to /tracking/partner-links
                `;

                setTimeout(function () {
                  output.innerHTML += '<br><br><em>✓ Form submission prevented - no page reload</em>';
                }, 500);
              })
              .catch(function (error) {
                console.error('Error:', error);
                output.innerHTML = `<strong>FAILED</strong><br>${error.message}`;
              });
          } else if (!isAjaxMode) {
            // In traditional mode, tracking fires but page will reload
            console.log('Traditional mode: Tracking fired, page will reload...');
          }
        } else {
          output.innerHTML = 'ERROR: No form data extracted';
        }
      });
    });
  </script>
</body>

</html>
